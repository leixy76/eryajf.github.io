(window.webpackJsonp=window.webpackJsonp||[]).push([[194],{537:function(s,t,a){"use strict";a.r(t);var e=a(0),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("br"),t("ArticleTopAd")],1),s._v(" "),t("h2",{attrs:{id:"原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),t("p",[s._v("当我们基于 Dockerfile 构建一个镜像的时候，不可避免的会遇到错误或失败，这个时候，通常我们会核查对应步骤执行的指令，然后调整指令，再次构建镜像，这是一种常规的方法。")]),s._v(" "),t("p",[s._v("其实，因为 Docker 底层存储的机制，我们可以直接进入到失败之前成功的那次状态中，然后二次调试我们的指令，从而做到有的放矢地验证。")]),s._v(" "),t("p",[s._v("docker 基于 Dockerfile 构建一个镜像的流程大致如下：")]),s._v(" "),t("ol",[t("li",[s._v("基于 "),t("code",[s._v("FROM")]),s._v(" 的基础镜像运行一个临时容器")]),s._v(" "),t("li",[s._v("在临时容器当中，执行 Dockerfile 中定义的指令")]),s._v(" "),t("li",[s._v("然后执行类似 "),t("code",[s._v("docker commit")]),s._v(" 的操作，生成一个全新的"),t("code",[s._v("镜像层")])]),s._v(" "),t("li",[s._v("Docker会再基于刚刚提交的镜像运行一个新容器")]),s._v(" "),t("li",[s._v("接着重复 "),t("code",[s._v("2 ~ 4")]),s._v(" 步，直到 Dockerfile 中的所有指令执行完毕。")])]),s._v(" "),t("p",[s._v("因此，当我们遇到构建失败的时候，只需要复原出错前一步的 Docker 容器，即可回溯到出错前的环境，然后再手动执行出错的命令来分析出错的原因即可。")]),s._v(" "),t("p",[t("img",{attrs:{src:"http://t.eryajf.net/imgs/2022/10/614b90515388dca3.png",alt:""}})]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("申明")]),s._v(" "),t("p",[t("strong",[s._v("原创文章"),t("Badge",{attrs:{text:"eryajf"}}),s._v("，未经授权，严禁转载，侵权必究！此乃文中随机水印，敬请读者谅解。")],1)]),s._v(" "),t("div",{staticClass:"custom-block right"},[t("p",[s._v("Copyright  "),t("a",{attrs:{href:"https://wiki.eryajf.net",target:"_blank",rel:"noopener noreferrer"}},[s._v("二丫讲梵"),t("OutboundLink")],1),s._v(" 版权所有")])])]),s._v(" "),t("h2",{attrs:{id:"实践"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),t("p",[s._v("有如下 Dockerfile 文件：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" Dockerfile\nFROM registry.cn-hangzhou.aliyuncs.com/eryajf/centos:7.5\nRUN "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aaa'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/test\nRUN ehco "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'bbb'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /opt/test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("这里可以看到，第三行指令的 echo 命令拼写有误，此时镜像构建日志如下：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\nSending build context to Docker daemon  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".048kB\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/3 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" FROM registry.cn-hangzhou.aliyuncs.com/eryajf/centos:7.5\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" a290d4e5c19d\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/3 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" RUN "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aaa'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/test\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 706e69349e9a\nRemoving intermediate container 706e69349e9a\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ad3fb6309109\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("/3 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" RUN ehco "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'bbb'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /opt/test\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" bec27c733f58\n/bin/sh: ehco: "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" not found\nThe "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("command")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/bin/sh -c ehco '")]),s._v("bbb"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("' >> /opt/test'")]),s._v(" returned a non-zero code: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("可以看到步骤 3 执行有异常，但是步骤 2 是正常执行的，我们可以执行如下命令拉起一个步骤 2 的环境：")]),s._v(" "),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" ad3fb6309109 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/test"')]),s._v("\naaa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("如上命令可以看到第二行的 echo 指令已经正常执行，而且环境也是当时的现场，这个时候我们就可以基于当时的现场，进行后续指令的调试。")]),s._v(" "),t("p",[t("br"),t("ArticleTopAd")],1)])}),[],!1,null,null,null);t.default=n.exports}}]);